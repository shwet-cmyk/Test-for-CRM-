@page "/login"
@attribute [AllowAnonymous]
@inject IAuthService AuthService
@inject IJSRuntime JS
@inject IConfiguration Configuration
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Login</PageTitle>

<div class="auth-shell">
    <div class="auth-pane info-pane">
        <div class="brand">
            <img src="/images/tez-erp-logo.png" alt="TEZ ERP" />
            <div class="brand-text">
                <div class="brand-title">TEZ ERP®</div>
                <div class="brand-subtitle">e-Business suite for SME</div>
            </div>
        </div>
        <div class="info-body">
            <p class="lede">Secure sign-in for BOS Global CRM with single-session enforcement and realm-aware access.</p>
            <ul class="info-list">
                <li>Only one active session per user. Previous sessions are terminated automatically.</li>
                <li>Ensure you are on HTTPS before signing in.</li>
                <li>Sessions expire after inactivity; simply sign in again to continue.</li>
            </ul>
            <div class="links">
                <a href="/about">About</a>
                <span>•</span>
                <a href="/privacy">Privacy Policy</a>
                <span>•</span>
                <a href="/terms">Terms of Service</a>
            </div>
        </div>
    </div>

    <div class="auth-pane form-pane">
        <div class="card-surface">
            <div class="card-header">
                <div>
                    <div class="card-title">Sign in</div>
                    <div class="card-subtitle">Use your username or email and password</div>
                </div>
                <div class="card-actions">
                    @if (IsSubmitting)
                    {
                        <div class="spinner" aria-label="Signing in"></div>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert-block" role="alert">@ErrorMessage</div>
            }

            <EditForm Model="LoginModel" OnValidSubmit="HandleLoginAsync">
                <DataAnnotationsValidator />

                <div class="field-group">
                    <label class="field-label">Login as</label>
                    <div class="segmented">
                        <button type="button" class="@GetRealmClass("User")" @onclick="@(() => SetRealm("User"))">User</button>
                        <button type="button" class="@GetRealmClass("Partner")" @onclick="@(() => SetRealm("Partner"))">Partner</button>
                        <button type="button" class="@GetRealmClass("Employee")" @onclick="@(() => SetRealm("Employee"))">Employee</button>
                    </div>
                </div>

                @if (TenantsForSelection?.Any() == true)
                {
                    <div class="field-group">
                        <label class="field-label" for="tenant">Tenant</label>
                        <InputSelect id="tenant" @bind-Value="LoginModel.SelectedTenantId" class="field-input">
                            <option value="@Guid.Empty">Select tenant</option>
                            @foreach (var tenant in TenantsForSelection)
                            {
                                <option value="@tenant.Id">@tenant.Name (@tenant.Realm)</option>
                            }
                        </InputSelect>
                    </div>
                }

                <div class="field-group">
                    <label class="field-label" for="email">Username or Email</label>
                    <InputText @bind-Value="LoginModel.Email" id="email" class="field-input" autocomplete="username" />
                    <ValidationMessage For="@(() => LoginModel.Email)" />
                </div>

                <div class="field-group">
                    <label class="field-label" for="password">Password</label>
                    <InputText @bind-Value="LoginModel.Password" id="password" type="password" class="field-input" autocomplete="current-password" />
                    <ValidationMessage For="@(() => LoginModel.Password)" />
                </div>

                <div class="field-group inline">
                    <div class="checkbox-line">
                        <InputCheckbox @bind-Value="LoginModel.RememberMe" id="remember" />
                        <label for="remember">Remember me</label>
                    </div>
                    <a class="inline-link" href="/forgot-password">Forgot password?</a>
                </div>

                <div class="action-row">
                    @if (ShowTerminateButton)
                    {
                        <button class="ghost-button" type="button" @onclick="TerminateOtherSessionAsync" disabled="@IsSubmitting">Terminate previous session</button>
                    }
                    <button class="primary-button" type="submit" disabled="@IsSubmitting">
                        @(IsSubmitting ? "Signing in..." : "Sign in")
                    </button>
                </div>

                <div class="footnote">
                    Not registered? <a href="/register">Create an account</a>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private LoginRequestDto LoginModel { get; set; } = new();
    private string? ErrorMessage { get; set; }
    private bool IsSubmitting { get; set; }
    private bool ShowTerminateButton { get; set; }
    private IEnumerable<TenantSummaryDto>? TenantsForSelection { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            Navigation.NavigateTo("/");
            return;
        }

        SetRealm("User");
    }

    private async Task HandleLoginAsync()
    {
        ErrorMessage = null;
        ShowTerminateButton = false;
        TenantsForSelection = null;
        IsSubmitting = true;
        try
        {
            if (LoginModel.SelectedTenantId == Guid.Empty)
            {
                LoginModel.SelectedTenantId = null;
            }
            // if recaptcha site key configured, execute on client to get token
            var siteKey = Configuration["Recaptcha:SiteKey"];
            if (!string.IsNullOrWhiteSpace(siteKey))
            {
                try
                {
                    var token = await JS.InvokeAsync<string>("recaptcha.executeRecaptcha", siteKey);
                    LoginModel.RecaptchaToken = token;
                }
                catch
                {
                    // ignore and let server-side fail if necessary
                }
            }

            // Optionally add device/location info
            try
            {
                var userAgent = await JS.InvokeAsync<string>("navigator.userAgent");
                LoginModel.DeviceInfo = userAgent;
            }
            catch { }

            var result = await AuthService.LoginAsync(LoginModel);
            if (result.Success)
            {
                // Redirect to role-specific dashboard if provided
                if (!string.IsNullOrWhiteSpace(result.RedirectUrl))
                {
                    Navigation.NavigateTo(result.RedirectUrl, true);
                }
                else
                {
                    Navigation.NavigateTo("/", true);
                }
            }
            else if (result.RequiresTwoFactor)
            {
                // redirect to 2FA page
                Navigation.NavigateTo($"/twofactor?userId={result.UserId}");
                return;
            }
            else if (result.ErrorCode == "ActiveSessionExists")
            {
                // Show a termination option to allow the user to kill other session and retry
                ErrorMessage = result.ErrorMessage ?? "Another session is active.";
                ShowTerminateButton = true;
                return;
            }
            else if (result.ErrorCode == "TenantSelectionRequired")
            {
                TenantsForSelection = result.Tenants;
                ErrorMessage = result.ErrorMessage ?? "Please choose a tenant.";
                return;
            }
            else
            {
                ErrorMessage = result.ErrorMessage ?? "Invalid login attempt.";
            }
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private async Task TerminateOtherSessionAsync()
    {
        ShowTerminateButton = false;
        await AuthService.TerminateActiveSessionAsync(LoginModel.Email);
        // retry login automatically once
        await HandleLoginAsync();
    }

    private void SetRealm(string realm)
    {
        LoginModel.SelectedRole = realm;
        LoginModel.SelectedRealm = realm;
    }

    private string GetRealmClass(string realm)
    {
        var isActive = string.Equals(LoginModel.SelectedRole, realm, StringComparison.OrdinalIgnoreCase);
        return isActive ? "segment active" : "segment";
    }
}
