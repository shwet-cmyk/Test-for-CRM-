@page "/login"
@attribute [AllowAnonymous]

@using BOSGlobal.Crm.Application.DTOs
@using BOSGlobal.Crm.Application.Interfaces
@using Microsoft.AspNetCore.Components.Authorization

@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Login</PageTitle>

<EditForm Model="LoginModel" OnValidSubmit="HandleLoginAsync">
    <DataAnnotationsValidator />

    <div class="card p-4" style="max-width:420px;margin:auto;margin-top:40px;">

        <h3 class="mb-3">Sign in</h3>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger">@ErrorMessage</div>
        }

        <!-- LOGIN ROLE -->
        <div class="mb-3">
            <label class="form-label">Login as</label>

            <div>
                <input type="radio" name="role" value="User"
                       checked="@("User" == LoginModel.SelectedRole)"
                       @onchange="@(() => LoginModel.SelectedRole = "User")" />
                <span>User</span>
            </div>

            <div>
                <input type="radio" name="role" value="Partner"
                       checked="@("Partner" == LoginModel.SelectedRole)"
                       @onchange="@(() => LoginModel.SelectedRole = "Partner")" />
                <span>Partner</span>
            </div>

            <div>
                <input type="radio" name="role" value="Employee"
                       checked="@("Employee" == LoginModel.SelectedRole)"
                       @onchange="@(() => LoginModel.SelectedRole = "Employee")" />
                <span>Employee</span>
            </div>
        </div>

        <!-- EMAIL -->
        <div class="mb-3">
            <label>Email</label>
            <InputText class="form-control" @bind-Value="LoginModel.Email" />
        </div>

        <!-- PASSWORD -->
        <div class="mb-3">
            <label>Password</label>
            <InputText class="form-control" type="password" @bind-Value="LoginModel.Password" />
        </div>

        <button class="btn btn-primary w-100" type="submit">
            SIGN IN
        </button>

    </div>
</EditForm>

@code {

    private LoginRequestDto LoginModel = new()
    {
        SelectedRole = "User"
    };

    private string? ErrorMessage;

    private async Task HandleLoginAsync()
    {
        var result = await AuthService.LoginAsync(LoginModel);

        if (result.Success)
        {
            Navigation.NavigateTo("/", true);
        }
        else
        {
            ErrorMessage = result.ErrorMessage ?? "Invalid login";
        }
    }
}
