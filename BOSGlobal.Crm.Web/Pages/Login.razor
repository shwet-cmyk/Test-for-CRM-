@page "/login"
@attribute [AllowAnonymous]
@inject IAuthService AuthService
@inject IJSRuntime JS
@inject IConfiguration Configuration
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Login</PageTitle>

<div class="row">
    <div class="col-sm-7">
        <div class="py-4">
            <img src="/images/tez-erp-logo.png" alt="TEZ ERP" style="max-width:220px;" />
            <h2 class="mt-3">TEZ ERP® — e-Business suite for SME</h2>
            <p>Sign in for registered users. Registered users can sign into their account using this screen. Usage of the portal is subject to Terms &amp; Conditions.</p>

            <ul>
                <li>Only one connection can be active for each user at any given time. If your user ID is active from another device, you will need to terminate that connection before sign-in.</li>
                <li>Before entering your login credentials, verify you are using a secure connection (https://).</li>
                <li>Your session will be automatically terminated if the server does not receive any response for 10 minutes.</li>
            </ul>

            <h5>TEZ ERP highlights</h5>
            <p>ERP | CRM | Sales Automation | Inventory | Reports | Multi-Location | E-Invoicing | MIS Alerts</p>

            <h6>Links</h6>
            <p>
                <a href="/about">About</a> • <a href="/privacy">Privacy Policy</a> • <a href="/terms">Terms of Service</a>
            </p>
        </div>
    </div>

    <div class="col-sm-5">
        <div class="card p-4">
            <h3 class="card-title">Sign in</h3>

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert alert-danger">@ErrorMessage</div>
            }

            <EditForm Model="LoginModel" OnValidSubmit="HandleLoginAsync">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-3">
                    <label class="form-label">Login as</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="loginRole" id="roleUser" value="User" @onclick="() => LoginModel.SelectedRole = "User"" checked="@(LoginModel.SelectedRole == "User")" />
                            <label class="form-check-label" for="roleUser">User</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="loginRole" id="rolePartner" value="Partner" @onclick="() => LoginModel.SelectedRole = "Partner"" checked="@(LoginModel.SelectedRole == "Partner")" />
                            <label class="form-check-label" for="rolePartner">Partner</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="loginRole" id="roleEmployee" value="Employee" @onclick="() => LoginModel.SelectedRole = "Employee"" checked="@(LoginModel.SelectedRole == "Employee")" />
                            <label class="form-check-label" for="roleEmployee">Employee</label>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Enter module(s)</label>
                    <div>
                        @foreach (var module in AvailableModules)
                        {
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="mod_@module" checked="@IsModuleSelected(module)" @onclick="() => ToggleModule(module)" />
                                <label class="form-check-label" for="mod_@module">@module</label>
                            </div>
                        }
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label" for="email">User Name / Email</label>
                    <InputText @bind-Value="LoginModel.Email" id="email" class="form-control" />
                </div>
                <div class="mb-3">
                    <label class="form-label" for="password">Password</label>
                    <InputText @bind-Value="LoginModel.Password" id="password" type="password" class="form-control" />
                </div>
                <div class="mb-3 form-check">
                    <InputCheckbox @bind-Value="LoginModel.RememberMe" id="remember" class="form-check-input" />
                    <label class="form-check-label" for="remember">Remember me</label>
                </div>

                <div class="d-flex">
                    <button class="btn btn-primary" type="submit">SIGN IN</button>
                    @if (ShowTerminateButton)
                    {
                        <button class="btn btn-warning ms-2" type="button" @onclick="TerminateOtherSessionAsync">Terminate previous session</button>
                    }
                </div>

                <div class="mt-3">
                    <a href="/forgot-password">Forgot Password?</a>
                    <div>Not registered? <a href="/register">Sign Up</a></div>
                </div>
            </EditForm>

            <hr />
            <small class="text-muted">Registered users: enter your common Username, your Email ID and password. Username is common to all users in your organisation.</small>
        </div>
    </div>
</div>

@code {
    private LoginRequestDto LoginModel { get; set; } = new();
    private string? ErrorMessage { get; set; }
    private bool ShowTerminateButton { get; set; }
    private List<string> AvailableModules { get; } = new() { "CRM", "Accounting", "Inventory", "HR", "Sales" };

    private bool IsModuleSelected(string module) => LoginModel.SelectedModules?.Contains(module) == true;

    private void ToggleModule(string module)
    {
        LoginModel.SelectedModules ??= new List<string>();
        if (LoginModel.SelectedModules.Contains(module))
            LoginModel.SelectedModules.Remove(module);
        else
            LoginModel.SelectedModules.Add(module);
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            Navigation.NavigateTo("/");
        }
    }

    private async Task HandleLoginAsync()
    {
        ErrorMessage = null;
        ShowTerminateButton = false;
        // if recaptcha site key configured, execute on client to get token
        var siteKey = Configuration["Recaptcha:SiteKey"];
        if (!string.IsNullOrWhiteSpace(siteKey))
        {
            try
            {
                var token = await JS.InvokeAsync<string>("recaptcha.executeRecaptcha", siteKey);
                LoginModel.RecaptchaToken = token;
            }
            catch
            {
                // ignore and let server-side fail if necessary
            }
        }

        // Optionally add device/location info
        try
        {
            var userAgent = await JS.InvokeAsync<string>("navigator.userAgent");
            LoginModel.DeviceInfo = userAgent;
        }
        catch { }

        var result = await AuthService.LoginAsync(LoginModel);
        if (result.Success)
        {
            // Redirect to role-specific dashboard if provided
            if (!string.IsNullOrWhiteSpace(result.RedirectUrl))
            {
                Navigation.NavigateTo(result.RedirectUrl, true);
            }
            else
            {
                Navigation.NavigateTo("/", true);
            }
        }
        else if (result.RequiresTwoFactor)
        {
            // redirect to 2FA page
            Navigation.NavigateTo($"/twofactor?userId={result.UserId}");
        }
        else if (result.ErrorCode == "ActiveSessionExists")
        {
            // Show a termination option to allow the user to kill other session and retry
            ErrorMessage = result.ErrorMessage ?? "Another session is active.";
            ShowTerminateButton = true;
        }
        else
        {
            ErrorMessage = result.ErrorMessage ?? "Invalid login attempt.";
        }
    }

    private async Task TerminateOtherSessionAsync()
    {
        ShowTerminateButton = false;
        await AuthService.TerminateActiveSessionAsync(LoginModel.Email);
        // retry login automatically once
        await HandleLoginAsync();
    }
}
